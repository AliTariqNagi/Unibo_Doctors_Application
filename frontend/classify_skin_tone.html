<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skin Tone Classification</title>
  <style>
    body { 
      font-family: sans-serif; 
      padding: 20px; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      background-color: #f4f4f4;
    }
    h1 { margin-bottom: 20px; color: #333; }

    .selection-container { 
      margin-bottom: 20px; 
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 10px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .selection-container label { 
      font-weight: bold; 
      color: #555;
      text-align: center;
    }
    .selection-container select { 
      width: calc(100% - 20px);
      padding: 10px; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
      font-size: 1em; 
      background-color: #fff;
    }

    .image-grid-container { 
      margin-bottom: 10px; 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      width: 100%;
      max-width: 900px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .image-pair { 
      display: flex; 
      flex-direction: column;
      gap: 5px; 
      align-items: center; 
      border: 1px solid #f0f0f0;
      border-radius: 5px;
      padding: 10px;
      background-color: #fafafa;
    }
    .image-pair img { 
      max-width: 100%;
      height: auto; 
      border: 1px solid #ddd; 
      border-radius: 5px; 
    }
    .classification-form { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .fitzpatrick-guide { max-width: 100%; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
    .classification-form select { 
      padding: 8px; 
      margin-bottom: 15px; 
      border-radius: 4px; 
      border: 1px solid #ccc; 
      width: 200px; 
    }
    button { 
      background-color: #551A8B; 
      color: white; 
      padding: 8px 15px; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      font-size: 14px; 
      margin: 5px;
    }
    button:hover { background-color: #440077; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }

    #message-container, #error-container { 
      margin-top: 10px; 
      font-weight: bold; 
      text-align: center; 
      width: 100%;
    }
    #error-container { color: red; }
    #message-container { color: green; }

    .pagination-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .home-button {
      margin-top: 20px; 
      padding: 10px; 
      background-color: #f0f0f0; 
      color: #333; 
      border: 1px solid #ccc; 
      border-radius: 5px; 
      text-decoration: none; 
      width: 100px;
      text-align: center;
    }
    .home-button:hover { background-color: #e0e0e0; }
  </style>
</head>
<body>
  <h1>Skin Tone Classification</h1>

  <div class="selection-container">
    <label for="doctor-select">Select Doctor:</label>
    <select id="doctor-select"><option value="">-- Select Doctor --</option></select>

    <label for="validation-status-select">Validation Status:</label>
    <select id="validation-status-select">
      <option value="all">All Images</option>
      <option value="unvalidated">Yet to be Validated</option>
      <option value="validated">Already Validated</option>
    </select>

    <label for="patient-select">Select Patient (Persona ID):</label>
    <select id="patient-select"><option value="">-- Select Patient --</option></select>
  </div>

  <div class="image-grid-container" id="patient-images-grid"></div>

  <div class="pagination-controls">
    <button id="prev-button" disabled>Previous</button>
    <button id="next-button" disabled>Next</button>
  </div>

  <div class="classification-form" id="classification-form" style="display:none;">
    <label for="fitzpatrick-scale">How do you classify the skin tone?</label>
    <img src="https://medicalimages.apice.unibo.it/images/fitzpatrick.jpg" alt="Fitzpatrick Scale Guide" class="fitzpatrick-guide" />
    <select id="fitzpatrick-scale">
      <option value="">-- Select Scale --</option>
      <option value="Type I">Type I</option>
      <option value="Type II">Type II</option>
      <option value="Type III">Type III</option>
      <option value="Type IV">Type IV</option>
      <option value="Type V">Type V</option>
      <option value="Type VI">Type VI</option>
    </select>
    <select id="confidence_score">
      <option value="">-- Confidence --</option>
      <option value="1">1 - Not confident</option>
      <option value="2">2 - Slightly confident</option>
      <option value="3">3 - Somewhat unconfident</option>
      <option value="4">4 - Neutral / Unsure</option>
      <option value="5">5 - Somewhat confident</option>
      <option value="6">6 - Mostly confident</option>
      <option value="7">7 - Extremely confident</option>
    </select>
    <button id="classify-button" disabled>Submit</button>
    <div id="message-container"></div>
    <div id="error-container"></div>
  </div>

  <a href="/" class="home-button">Home</a>

  <script>
    const doctorSelect = document.getElementById('doctor-select');
    const validationStatusSelect = document.getElementById('validation-status-select');
    const patientSelect = document.getElementById('patient-select');
    const patientImagesGrid = document.getElementById('patient-images-grid');
    const classificationForm = document.getElementById('classification-form');
    const fitzpatrickScaleSelect = document.getElementById('fitzpatrick-scale');
    const classifyButton = document.getElementById('classify-button');
    const messageContainer = document.getElementById('message-container');
    const errorContainer = document.getElementById('error-container');
    const confidenceScoreSelect = document.getElementById("confidence_score");
    const prevButton = document.getElementById("prev-button");
    const nextButton = document.getElementById("next-button");

    const backendUrl = 'https://medicalimages.apice.unibo.it';

    let currentPatient = null;
    let allImages = [];
    let currentPage = 0;
    const pageSize = 20;

    function checkSelections() {
      classifyButton.disabled = !(doctorSelect.value && patientSelect.value && fitzpatrickScaleSelect.value && confidenceScoreSelect.value);
    }

    async function loadDoctors() {
      const response = await fetch(`${backendUrl}/doctors/`);
      const doctors = await response.json();
      doctorSelect.innerHTML = '<option value="">-- Select Doctor --</option>';
      doctors.forEach(doc => {
        doctorSelect.innerHTML += `<option value="${doc.doctor_name}">${doc.doctor_name}</option>`;
      });
    }

    async function loadUniquePatients(status) {
      patientSelect.innerHTML = '<option value="">-- Select Patient --</option>'; 
      const response = await fetch(`${backendUrl}/unique_patients/?validation_status=${status}`);
      const patients = await response.json();
      patients.forEach(p => {
        patientSelect.innerHTML += `<option value="${p}">${p}</option>`;
      });
    }

    function renderImages() {
      patientImagesGrid.innerHTML = "";
      const start = currentPage * pageSize;
      const end = start + pageSize;
      const images = allImages.slice(start, end);

      images.forEach(img => {
        const div = document.createElement("div");
        div.classList.add("image-pair");
        div.innerHTML = `<img src="${backendUrl}${img.image_path}" alt="${img.image_name}">`;
        patientImagesGrid.appendChild(div);
      });

      prevButton.disabled = currentPage === 0;
      nextButton.disabled = end >= allImages.length;
    }

    async function loadPatientImages(patient, status) {
      currentPatient = patient;
      currentPage = 0;
      const response = await fetch(`${backendUrl}/patient_images/${patient}?validation_status=${status}`);
      allImages = await response.json();
      renderImages();
      classificationForm.style.display = allImages.length ? "flex" : "none";
    }

    doctorSelect.addEventListener("change", checkSelections);
    validationStatusSelect.addEventListener("change", () => loadUniquePatients(validationStatusSelect.value));
    patientSelect.addEventListener("change", () => {
      loadPatientImages(patientSelect.value, validationStatusSelect.value);
    });
    fitzpatrickScaleSelect.addEventListener("change", checkSelections);
    confidenceScoreSelect.addEventListener("change", checkSelections);

    prevButton.addEventListener("click", () => {
      if (currentPage > 0) {
        currentPage--;
        renderImages();
      }
    });
    nextButton.addEventListener("click", () => {
      if ((currentPage + 1) * pageSize < allImages.length) {
        currentPage++;
        renderImages();
      }
    });

    window.onload = async () => {
      await loadDoctors();
      await loadUniquePatients("all");
    };
    classifyButton.addEventListener("click", async () => {
        errorContainer.textContent = "";
        messageContainer.textContent = "";

        const doctor = doctorSelect.value;
        const patient = patientSelect.value;
        const scale = fitzpatrickScaleSelect.value;
        const confidence = confidenceScoreSelect.value;

        if (!doctor || !patient || !scale || !confidence) {
            errorContainer.textContent = "Please select all fields before classifying.";
            return;
        }

        try {
            const response = await fetch(`${backendUrl}/classify_skin_tone/${patient}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                doctor_name: doctor,
                fitzpatrick_scale: scale,
                confidence: parseInt(confidence)

            })
            });

            if (response.ok) {
            messageContainer.textContent = "Submitted successfully!";
            fitzpatrickScaleSelect.value = "";
            confidenceScoreSelect.value = "";
            classifyButton.disabled = true;
            
            await loadUniquePatients(validationStatusSelect.value);
              if (patientSelect.value) {
                await loadPatientImages(patientSelect.value, validationStatusSelect.value);
              } else {
                patientImagesGrid.innerHTML = "";
                classificationForm.style.display = "none";
              }


            } else {
            const err = await response.json();
            errorContainer.textContent = err.detail || "Error submitting classification.";
            }
        } catch (err) {
            console.error(err);
            errorContainer.textContent = "Network error. Please try again.";
        }
        });

  </script>
</body>
</html>
